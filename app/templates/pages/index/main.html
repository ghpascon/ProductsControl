{% extends "base.html" %} 
{% block content %}
<!-- Main Layout Container -->
<!-- Painel de Pedidos -->

<div class="min-h-screen p-6" x-data="orderPanel()" x-init="init()">
  <!-- Barra de Filtros e BotÃ£o de Atualizar -->
  <div
    class="max-w-7xl mx-auto mb-6 bg-white/80 border border-slate-200 rounded-2xl shadow-sm p-5"
  >
    <div class="flex justify-between items-center mb-4">
      <!-- Div dos Filtros -->
      <div class="flex flex-wrap gap-2">
        <template x-for="tab in filterTabs" :key="tab.key">
          <button
            @click="console.log('ðŸ”„ Mudando filtro para:', tab.key); if(tab.key === 'numero') console.log('ðŸ“‹ OrderNumbers ao ativar filtro numero:', orderNumbers); activeFilter = tab.key; resetFilterFields()"
            :class="activeFilter === tab.key ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            x-text="tab.label"
          ></button>
        </template>
      </div>

      <!-- BotÃ£o de Atualizar -->
      <button
        @click="applyFilter()"
        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-xl shadow-sm transition-all"
      >
        <svg
          :class="loading && 'animate-spin'"
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          />
        </svg>
        <span x-text="loading ? 'Carregando...' : 'Atualizar'"></span>
      </button>
    </div>

    <!-- ConteÃºdo do Card -->
    <div class="flex flex-wrap items-end gap-3">
      <!-- Por Cliente -->
      <div
        x-show="activeFilter === 'cliente'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Cliente</label
          >
          {{ combobox("clientSearch", "filter.clientName", "() => customers", "c => c.client_name || c", "client_name", "Selecione um cliente") }}
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.clientName"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por CNPJ -->
      <div
        x-show="activeFilter === 'cnpj'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >CNPJ</label
          >
          {{ combobox("cnpjSearch", "filter.cnpj", "() => cnpjs.map(item => ({ value: item, label: item }))", "item => item.label || item", "value", "Selecione um CNPJ") }}
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.cnpj"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por NÃºmero do Pedido -->
      <div
        x-show="activeFilter === 'numero'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >NÃºmero do Pedido</label
          >
          {{ combobox("orderNumberSearch", "filter.orderNumber", "() => orderNumbers.map(item => ({ value: String(item), label: String(item) }))", "item => item.label || item", "value", "Selecione um nÃºmero de pedido") }}
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.orderNumber"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por CÃ³digo de Produto -->
      <div
        x-show="activeFilter === 'codigo'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >CÃ³digo do Produto</label
          >
          {{ combobox("productCodeSearch", "filter.productCode", "() => productCodes.map(item => ({ value: item, label: item }))", "item => item.label || item", "value", "Selecione um cÃ³digo de produto") }}
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.productCode"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por Tipo de Leitor -->
      <div
        x-show="activeFilter === 'tipo'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Tipo de Leitor</label
          >
          {{ combobox("readerTypeSearch", "filter.readerTypeId", "() => readerTypes", "rt => rt.id + ' â€” ' + rt.name", "id", "Selecione um tipo de leitor") }}
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.readerTypeId"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por Leitor -->
      <div
        x-show="activeFilter === 'leitor'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[200px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Serial do Leitor</label
          >
          <input
            type="text"
            x-model="filter.readerId"
            placeholder="Digite o serial do leitor"
            class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800 font-mono focus:outline-none focus:ring-2 focus:ring-blue-400"
            @keydown.enter="applyFilter()"
          />
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.readerId"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Por Data -->
      <div
        x-show="activeFilter === 'data'"
        x-transition
        class="flex flex-wrap items-end gap-3"
      >
        <div class="flex-1 min-w-[160px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Campo de Data</label
          >
          <select
            x-model="filter.dateField"
            class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-400"
          >
            <option value="created_at">Data de CriaÃ§Ã£o</option>
            <option value="mounted_at">Data de Montagem</option>
            <option value="tested_at">Data de Teste</option>
            <option value="shipped_at">Data de Envio</option>
            <option value="activated_at">Data de AtivaÃ§Ã£o</option>
          </select>
        </div>
        <div class="flex-1 min-w-[160px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Data Inicial</label
          >
          <input
            type="date"
            x-model="filter.startDate"
            class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
        </div>
        <div class="flex-1 min-w-[160px]">
          <label
            class="block text-s font-semibold text-slate-500 uppercase mb-1"
            >Data Final</label
          >
          <input
            type="date"
            x-model="filter.endDate"
            class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
        </div>
        <button
          @click="applyFilter()"
          :disabled="!filter.startDate || !filter.endDate"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-medium rounded-xl transition-all"
        >
          Filtrar
        </button>
      </div>

      <!-- Todos -->
      <div
        x-show="activeFilter === 'todos'"
        class="text-sm text-slate-400 italic"
      >
        Exibindo todos os pedidos â€” use as abas acima para filtrar.
      </div>

      <div
        x-show="error"
        class="w-full mt-4 p-4 bg-red-50 border border-red-200 rounded-xl"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <svg
              class="w-5 h-5 text-red-500 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p class="text-sm text-red-700 font-medium" x-text="error"></p>
          </div>
          <button
            @click="error = ''"
            class="text-red-400 hover:text-red-600 transition-colors"
            title="Fechar"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div
    class="max-w-7xl mx-auto mb-5 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3"
  >
    <template x-for="stat in stats" :key="stat.label">
      <div
        class="bg-white/80 border border-slate-200 rounded-xl p-4 shadow-sm flex items-center gap-3"
      >
        <div
          :class="stat.color"
          class="w-9 h-9 rounded-lg flex items-center justify-center text-white shrink-0"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              :d="stat.icon"
            />
          </svg>
        </div>
        <div>
          <p class="text-s text-slate-500 font-medium" x-text="stat.label"></p>
          <p class="text-lg font-bold text-slate-800" x-text="stat.value"></p>
        </div>
      </div>
    </template>
  </div>

  <!-- Filtro de Status -->
  <div class="max-w-7xl mx-auto mb-4 flex flex-wrap items-center gap-2">
    <span class="text-xs font-bold text-slate-400 uppercase tracking-wide mr-1"
      >Status:</span
    >
    <template x-for="s in statusTabs" :key="s.key">
      <button
        @click="statusFilter = s.key"
        :class="statusFilter === s.key ? s.activeClass : 'bg-slate-100 text-slate-500 hover:bg-slate-200'"
        class="px-3 py-1 rounded-full text-xs font-semibold transition-all"
        x-text="s.label"
      ></button>
    </template>
  </div>

  <!-- Grid de Pedidos -->
  <div class="max-w-7xl mx-auto">
    <!-- Skeleton -->
    <div
      x-show="loading"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
    >
      <template x-for="i in 6" :key="i">
        <div
          class="bg-white/80 border border-slate-200 rounded-2xl p-5 shadow-sm animate-pulse"
        >
          <div class="h-4 bg-slate-200 rounded w-1/3 mb-3"></div>
          <div class="h-3 bg-slate-100 rounded w-2/3 mb-2"></div>
          <div class="h-3 bg-slate-100 rounded w-1/2 mb-4"></div>
          <div class="flex gap-2">
            <div class="h-6 w-16 bg-slate-200 rounded-full"></div>
            <div class="h-6 w-16 bg-slate-200 rounded-full"></div>
          </div>
        </div>
      </template>
    </div>

    <!-- Vazio: sem pedidos na API -->
    <div
      x-show="!loading && orders.length === 0"
      class="flex flex-col items-center justify-center py-20 text-slate-400"
    >
      <svg
        class="w-14 h-14 mb-4 opacity-30"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
        />
      </svg>
      <p class="text-base font-medium">Nenhum pedido encontrado</p>
      <p class="text-sm mt-1">Tente ajustar os filtros ou atualize a pÃ¡gina.</p>
    </div>

    <!-- Vazio: pedidos existem mas filtro de status zerou -->
    <div
      x-show="!loading && orders.length > 0 && filteredOrders.length === 0"
      class="flex flex-col items-center justify-center py-16 text-slate-400"
    >
      <svg
        class="w-10 h-10 mb-3 opacity-30"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L13 13.414V19a1 1 0 01-.553.894l-4 2A1 1 0 017 21v-7.586L3.293 6.707A1 1 0 013 6V4z"
        />
      </svg>
      <p class="text-sm font-medium">Nenhum pedido com este status</p>
      <button
        @click="statusFilter = ''"
        class="mt-2 text-xs text-blue-500 hover:underline"
      >
        Limpar filtro de status
      </button>
    </div>

    <!-- Tabela de Pedidos -->
    <div
      x-show="!loading && filteredOrders.length > 0"
      class="overflow-x-auto bg-white/90 border border-slate-200 rounded-2xl shadow-sm"
    >
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr
            class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-400 uppercase tracking-widest"
          >
            <th class="px-4 py-3 text-left font-bold">NÂº Pedido</th>
            <th class="px-4 py-3 text-left font-bold">Cliente</th>
            <th class="px-4 py-3 text-left font-bold">CÃ³digo Produto</th>
            <th class="px-4 py-3 text-left font-bold">Tipo Leitor</th>
            <th class="px-4 py-3 text-left font-bold">Serial Leitor</th>
            <th class="px-4 py-3 text-left font-bold w-24">Criado</th>
            <th class="px-4 py-3 text-left font-bold w-24">Montado</th>
            <th class="px-4 py-3 text-left font-bold w-24">Testado</th>
            <th class="px-4 py-3 text-left font-bold w-24">Enviado</th>
            <th class="px-4 py-3 text-left font-bold w-24">Ativado</th>
            <th class="px-4 py-3 text-right font-bold w-28">Status</th>
            <th class="px-4 py-3 w-10"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="order in filteredOrders" :key="order.id">
            <tr
              @click="window.location.href = '{{ url_for("view_order_page", order_id=0) }}'.replace('/0', '/' + order.id)"
              class="border-b border-slate-100 last:border-0 hover:bg-blue-50/50 cursor-pointer transition-colors duration-150"
            >
              <td
                class="px-4 py-3 font-mono text-blue-600"
                x-text="order.order_number || 'â€”'"
              ></td>
              <td
                class="px-4 py-3 font-semibold text-slate-800"
                x-text="order.client_name || 'â€”'"
              ></td>
              <td
                class="px-4 py-3 text-slate-600 font-mono"
                x-text="order.product_code || 'â€”'"
              ></td>
              <td
                class="px-4 py-3 text-slate-600"
                x-text="(order.reader_type_name || order.reader_type?.name || 'â€”')"
                :title="order.reader_type_name ? `ID: ${order.reader_type_id || 'N/A'}` : ''"
              ></td>
              <td
                class="px-4 py-3 text-slate-600 font-mono"
                x-text="(order.reader_serial || order.reader?.serial_number || 'â€”')"
                :title="order.reader_id ? `Reader ID: ${order.reader_id}` : ''"
              ></td>

              <td
                class="px-4 py-3 text-s text-slate-400 whitespace-nowrap"
                x-text="formatDate(order.created_at)"
              ></td>
              <td
                class="px-4 py-3 text-s whitespace-nowrap"
                :class="order.mounted_at ? 'text-blue-600 font-medium' : 'text-slate-300'"
                x-text="formatDate(order.mounted_at)"
              ></td>
              <td
                class="px-4 py-3 text-s whitespace-nowrap"
                :class="order.tested_at ? 'text-cyan-600 font-medium' : 'text-slate-300'"
                x-text="formatDate(order.tested_at)"
              ></td>
              <td
                class="px-4 py-3 text-s whitespace-nowrap"
                :class="order.shipped_at ? 'text-indigo-600 font-medium' : 'text-slate-300'"
                x-text="formatDate(order.shipped_at)"
              ></td>
              <td
                class="px-4 py-3 text-s whitespace-nowrap"
                :class="order.activated_at ? 'text-emerald-600 font-medium' : 'text-slate-300'"
                x-text="formatDate(order.activated_at)"
              ></td>
              <td class="px-4 py-3 text-right">
                <span
                  :class="statusBadgeClass(order)"
                  class="text-s font-semibold px-2.5 py-1 rounded-full whitespace-nowrap"
                  x-text="statusLabel(order)"
                ></span>
              </td>
              <td class="px-4 py-3 text-slate-300">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function orderPanel() {
    return {
      orders: [],
      customers: [],
      cnpjs: [],
      orderNumbers: [],
      productCodes: [],
      readerTypes: [],
      readers: [],
      loading: true,
      error: "",
      activeFilter: "todos",
      statusFilter: "",
      filter: {
        clientName: "",
        cnpj: "",
        orderNumber: "",
        productCode: "",
        readerTypeId: "",
        readerId: "",
        startDate: "",
        endDate: "",
        dateField: "created_at",
      },
      filterTabs: [
        { key: "todos", label: "Todos" },
        { key: "cliente", label: "Por Cliente" },
        { key: "cnpj", label: "Por CNPJ" },
        { key: "numero", label: "Por NÂº Pedido" },
        { key: "codigo", label: "Por CÃ³digo" },
        { key: "tipo", label: "Por Tipo Leitor" },
        { key: "leitor", label: "Por Leitor" },
        { key: "data", label: "Por Data" },
      ],
      statusTabs: [
        { key: "", label: "Todos", activeClass: "bg-slate-700 text-white" },
        {
          key: "pendente",
          label: "Pendente",
          activeClass: "bg-amber-100 text-amber-700 ring-1 ring-amber-300",
        },
        {
          key: "montado",
          label: "Montado",
          activeClass: "bg-blue-100 text-blue-700 ring-1 ring-blue-300",
        },
        {
          key: "testado",
          label: "Testado",
          activeClass: "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-300",
        },
        {
          key: "enviado",
          label: "Enviado",
          activeClass: "bg-indigo-100 text-indigo-700 ring-1 ring-indigo-300",
        },
        {
          key: "ativado",
          label: "Ativado",
          activeClass:
            "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-300",
        },
      ],

      // FunÃ§Ã£o para normalizar dados dos pedidos
      normalizeOrders(orders) {
        if (!Array.isArray(orders)) return [];
        
        return orders.map(order => ({
          ...order,
          // Garantir que os campos do leitor estejam sempre presentes
          reader_serial: order.reader_serial || order.reader?.serial_number || null,
          reader_type_name: order.reader_type_name || order.reader_type?.name || null,
          reader_id: order.reader_id || order.reader?.id || null,
          reader_type_id: order.reader_type_id || order.reader_type?.id || null,
        }));
      },

      async init() {
        console.log('ðŸš€ Iniciando init() do orderPanel...');
        await Promise.all([
          this.loadOrders(),
          this.loadCustomers(),
          this.loadCnpjs(),
          this.loadOrderNumbers(),
          this.loadProductCodes(),
          this.loadReaderTypes(),
          this.loadReaders(),
        ]);
        console.log('âœ… Init concluÃ­do. OrderNumbers final:', this.orderNumbers);
      },

      resetFilterFields() {
        this.filter = {
          clientName: "",
          cnpj: "",
          orderNumber: "",
          productCode: "",
          readerTypeId: "",
          readerId: "",
          startDate: "",
          endDate: "",
          dateField: "created_at",
        };
        this.error = "";
        if (this.activeFilter === "todos") this.loadOrders();
      },

      async applyFilter() {
        this.error = "";
        if (this.activeFilter === "todos") return this.loadOrders();
        if (this.activeFilter === "cliente") {
          if (!this.filter.clientName) {
            this.error = "Selecione um cliente.";
            return;
          }
          return this.loadOrdersByClient(this.filter.clientName);
        }
        if (this.activeFilter === "cnpj") {
          if (!this.filter.cnpj) {
            this.error = "Selecione um CNPJ.";
            return;
          }
          return this.loadOrdersByCnpj(this.filter.cnpj);
        }
        if (this.activeFilter === "numero") {
          if (!this.filter.orderNumber) {
            this.error = "Selecione um nÃºmero de pedido.";
            return;
          }
          return this.loadOrdersByOrderNumber(this.filter.orderNumber);
        }
        if (this.activeFilter === "codigo") {
          if (!this.filter.productCode) {
            this.error = "Selecione um cÃ³digo de produto.";
            return;
          }
          return this.loadOrdersByProductCode(this.filter.productCode);
        }
        if (this.activeFilter === "tipo") {
          if (!this.filter.readerTypeId) {
            this.error = "Selecione um tipo de leitor.";
            return;
          }
          return this.loadOrdersByReaderType(this.filter.readerTypeId);
        }
        if (this.activeFilter === "leitor") {
          if (!this.filter.readerId) {
            this.error = "Digite o serial do leitor.";
            return;
          }
          return this.loadOrdersByReader(this.filter.readerId);
        }
        if (this.activeFilter === "data") {
          if (!this.filter.startDate || !this.filter.endDate) {
            this.error = "Preencha as duas datas.";
            return;
          }
          return this.loadOrdersByDate(
            this.filter.startDate,
            this.filter.endDate,
            this.filter.dateField,
          );
        }
      },



      async loadOrders() {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(URLS.getAllOrders);
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          console.log('ðŸ“‹ Dados carregados - total de pedidos:', this.orders.length);
          if (this.orders.length > 0) {
            console.log('ðŸ“„ Exemplo de pedido:', this.orders[0]);
            console.log('ðŸ” Campos do leitor no primeiro pedido:', {
              reader_serial: this.orders[0].reader_serial,
              reader_type_name: this.orders[0].reader_type_name,
              reader_id: this.orders[0].reader_id,
              reader_type_id: this.orders[0].reader_type_id,
              reader: this.orders[0].reader,
              reader_type: this.orders[0].reader_type
            });
          }
          if (this.orders.length === 0) {
            this.error = "Nenhum pedido encontrado.";
          }
        } catch (e) {
          console.error('Erro ao carregar pedidos:', e);
          this.error = `Erro ao carregar pedidos: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByClient(clientName) {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(
            URLS.getProductOrdersByClient.replace(
              "__CLIENT_NAME__",
              encodeURIComponent(clientName),
            ),
          );
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado para o cliente: ${clientName}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por cliente:', e);
          this.error = `Erro ao filtrar por cliente: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByCnpj(cnpj) {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(
            URLS.getProductOrdersByCnpj.replace(
              "__CNPJ__",
              encodeURIComponent(cnpj.replace(/\//g, "|"))
            ),
          );
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado para o CNPJ: ${cnpj}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por CNPJ:', e);
          this.error = `Erro ao filtrar por CNPJ: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByOrderNumber(orderNumber) {
        this.loading = true;
        this.error = "";
        console.log('Buscando pedidos por nÃºmero:', orderNumber);
        try {
          const res = await fetch(
            URLS.getProductOrdersByOrderNumber.replace(
              "__ORDER_NUMBER__",
              encodeURIComponent(orderNumber),
            ),
          );
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado com nÃºmero: ${orderNumber}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por nÃºmero do pedido:', e);
          this.error = `Erro ao filtrar por nÃºmero do pedido: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByProductCode(productCode) {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(
            URLS.getProductOrdersByProductCode.replace(
              "__PRODUCT_CODE__",
              encodeURIComponent(productCode),
            ),
          );
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado para o cÃ³digo de produto: ${productCode}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por cÃ³digo de produto:', e);
          this.error = `Erro ao filtrar por cÃ³digo de produto: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByReaderType(readerTypeId) {
        this.loading = true;
        this.error = "";
        try {
          // Encontrar o tipo de leitor pelo ID para obter o nome
          const readerType = this.readerTypes.find(rt => rt.id == readerTypeId);
          if (!readerType) {
            this.orders = [];
            this.error = "Tipo de leitor nÃ£o encontrado.";
            return;
          }

          // Usar a nova rota direta que busca pedidos por nome do tipo de leitor
          const res = await fetch(
            URLS.getProductOrdersByReaderTypeName.replace("__READER_TYPE_NAME__", encodeURIComponent(readerType.name)),
          );
          
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado para o tipo de leitor: ${readerType.name}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por tipo de leitor:', e);
          this.error = `Erro ao filtrar por tipo de leitor: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByReader(readerId) {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(
            URLS.getProductOrdersByReaderSerial.replace("__SERIAL_NUMBER__", encodeURIComponent(readerId)),
          );
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado para o leitor: ${readerId}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por leitor:', e);
          this.error = `Erro ao filtrar por leitor: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadOrdersByDate(startDate, endDate, dateField) {
        this.loading = true;
        this.error = "";
        try {
          // date input gives "YYYY-MM-DD"; enviar inÃ­cio e fim do dia
          const url = URLS.getProductOrdersByDate
            .replace(
              "__START_DATE__",
              encodeURIComponent(
                new Date(startDate + "T00:00:00").toISOString(),
              ),
            )
            .replace(
              "__END_DATE__",
              encodeURIComponent(new Date(endDate + "T23:59:59").toISOString()),
            )
            .replace("__FIELD__", dateField);
            
          const res = await fetch(url);
          if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Erro ${res.status}: ${errorData}`);
          }
          const data = await res.json();
          this.orders = this.normalizeOrders(data);
          if (this.orders.length === 0) {
            this.error = `Nenhum pedido encontrado entre ${startDate} e ${endDate} para o campo ${dateField}`;
          }
        } catch (e) {
          console.error('Erro ao filtrar por data:', e);
          this.error = `Erro ao filtrar por data: ${e.message}`;
          this.orders = [];
        } finally {
          this.loading = false;
        }
      },

      async loadCustomers() {
        try {
          const res = await fetch(URLS.getCustomers);
          if (!res.ok) {
            console.warn('Erro ao carregar clientes:', res.status);
            this.customers = [];
            return;
          }
          const customersData = await res.json();
          if (Array.isArray(customersData)) {
            this.customers = customersData.map((c) => ({
              client_name: c.client_name || c.name || c,
              value: c.client_name || c.name || c,
            }));
          } else {
            console.warn('Dados de clientes invÃ¡lidos:', customersData);
            this.customers = [];
          }
        } catch (e) {
          console.error('Erro ao carregar clientes:', e);
          this.customers = [];
        }
      },

      async loadCnpjs() {
        try {
          const res = await fetch(URLS.getCnpjs);
          if (!res.ok) {
            console.warn('Erro ao carregar CNPJs:', res.status);
            this.cnpjs = [];
            return;
          }
          const data = await res.json();
          this.cnpjs = Array.isArray(data) ? data : [];
        } catch (e) {
          console.error('Erro ao carregar CNPJs:', e);
          this.cnpjs = [];
        }
      },

      async loadOrderNumbers() {
        console.log('ðŸ”„ Iniciando carregamento de nÃºmeros de pedido...');
        try {
          console.log('ðŸŒ URL:', URLS.getOrdersNumbers);
          const res = await fetch(URLS.getOrdersNumbers);
          console.log('ðŸ“¡ Response status:', res.status, res.ok);
          
          if (!res.ok) {
            console.error('âŒ Erro na requisiÃ§Ã£o:', res.status, res.statusText);
            this.orderNumbers = [];
            return;
          }
          
          const data = await res.json();
          console.log('ðŸ“¦ Dados recebidos da API:', data);
          console.log('ðŸ“¦ Tipo dos dados:', typeof data, 'Ã‰ array:', Array.isArray(data));
          
          this.orderNumbers = Array.isArray(data) ? data : [];
          console.log('âœ… OrderNumbers definido:', this.orderNumbers);
          console.log('ðŸ“Š Quantidade de itens:', this.orderNumbers.length);
        } catch (error) {
          console.error('ðŸ’¥ Erro ao carregar order numbers:', error);
          this.orderNumbers = [];
        }
      },

      async loadProductCodes() {
        try {
          const res = await fetch(URLS.getProductCodes);
          if (!res.ok) {
            console.warn('Erro ao carregar cÃ³digos de produto:', res.status);
            this.productCodes = [];
            return;
          }
          const data = await res.json();
          this.productCodes = Array.isArray(data) ? data : [];
        } catch (e) {
          console.error('Erro ao carregar cÃ³digos de produto:', e);
          this.productCodes = [];
        }
      },

      async loadReaderTypes() {
        try {
          const res = await fetch(URLS.getReaderTypes);
          if (!res.ok) {
            console.warn('Erro ao carregar tipos de leitor:', res.status);
            this.readerTypes = [];
            return;
          }
          const data = await res.json();
          this.readerTypes = Array.isArray(data) ? data : [];
        } catch (e) {
          console.error('Erro ao carregar tipos de leitor:', e);
          this.readerTypes = [];
        }
      },

      async loadReaders() {
        try {
          const res = await fetch(URLS.getReaders);
          if (!res.ok) {
            console.warn('Erro ao carregar leitores:', res.status);
            this.readers = [];
            return;
          }
          const data = await res.json();
          this.readers = Array.isArray(data) ? data : [];
        } catch (e) {
          console.error('Erro ao carregar leitores:', e);
          this.readers = [];
        }
      },

      get stats() {
        const s = this.orders;
        const ativado = (o) => !!o.activated_at;
        const enviado = (o) => !o.activated_at && !!o.shipped_at;
        const testado = (o) =>
          !o.activated_at && !o.shipped_at && !!o.tested_at;
        const montado = (o) =>
          !o.activated_at && !o.shipped_at && !o.tested_at && !!o.mounted_at;
        const pendente = (o) =>
          !o.activated_at && !o.shipped_at && !o.tested_at && !o.mounted_at;
        return [
          {
            label: "Total",
            value: s.length,
            color: "bg-slate-500",
            icon: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2",
          },
          {
            label: "Pendentes",
            value: s.filter(pendente).length,
            color: "bg-amber-500",
            icon: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
          },
          {
            label: "Montados",
            value: s.filter(montado).length,
            color: "bg-blue-500",
            icon: "M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z",
          },
          {
            label: "Testados",
            value: s.filter(testado).length,
            color: "bg-cyan-500",
            icon: "M9 12l2 2 4-4M7 4a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2H7z",
          },
          {
            label: "Enviados",
            value: s.filter(enviado).length,
            color: "bg-indigo-500",
            icon: "M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4",
          },
          {
            label: "Ativados",
            value: s.filter(ativado).length,
            color: "bg-emerald-500",
            icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
          },
        ];
      },

      get filteredOrders() {
        if (!this.statusFilter) return this.orders;
        return this.orders.filter((o) => {
          if (this.statusFilter === "ativado") return !!o.activated_at;
          if (this.statusFilter === "enviado")
            return !o.activated_at && !!o.shipped_at;
          if (this.statusFilter === "testado")
            return !o.activated_at && !o.shipped_at && !!o.tested_at;
          if (this.statusFilter === "montado")
            return (
              !o.activated_at && !o.shipped_at && !o.tested_at && !!o.mounted_at
            );
          if (this.statusFilter === "pendente")
            return (
              !o.activated_at && !o.shipped_at && !o.tested_at && !o.mounted_at
            );
          return true;
        });
      },

      statusLabel(order) {
        if (order.activated_at) return "Ativado";
        if (order.shipped_at) return "Enviado";
        if (order.tested_at) return "Testado";
        if (order.mounted_at) return "Montado";
        return "Pendente";
      },

      statusBadgeClass(order) {
        if (order.activated_at)
          return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
        if (order.shipped_at)
          return "bg-indigo-100 text-indigo-700 ring-1 ring-indigo-200";
        if (order.tested_at)
          return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
        if (order.mounted_at)
          return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      },

      formatDate(value) {
        if (!value) return "â€”";
        try {
          return new Intl.DateTimeFormat("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          }).format(new Date(value));
        } catch (_) {
          return value;
        }
      },
    };
  }
</script>
{% endblock %}
