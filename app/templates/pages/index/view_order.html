{% extends "base.html" %} {% block content %}
<script>
  const VIEW_ORDER_URLS = {
    getDecodedOrder: "{{ url_for('get_decoded_order', order_id=order_id) }}",
    mount: "{{ url_for('product_order_mount',    order_id=order_id) }}",
    test: "{{ url_for('product_order_test',     order_id=order_id) }}",
    ship: "{{ url_for('product_order_ship',     order_id=order_id) }}",
    activate: "{{ url_for('product_order_activate', order_id=order_id) }}",
    addReaderToOrder:
      "{{ url_for('add_reader_to_order', order_id=order_id, reader_id=0) }}".replace(
        "/0",
        "/__RID__",
      ),
    getAvailableReaders: "{{ url_for('get_available_readers') }}",
    getDecodedReadersByIds:
      "{{ url_for('get_decoded_readers_by_ids', reader_ids='__IDS__') }}",
    back: "{{ url_for('index') }}",
  };
</script>

<div class="min-h-screen p-6" x-data="viewOrder()" x-init="init()">
  <div class="max-w-3xl mx-auto space-y-5">
    <!-- Voltar -->
    <a
      href="{{ url_for('index') }}"
      class="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-slate-800 transition-colors"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        />
      </svg>
      Voltar
    </a>

    <!-- Toast de feedback -->
    <div
      x-show="feedback.msg"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 translate-y-2"
      x-transition:enter-end="opacity-100 translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0"
      x-transition:leave-end="opacity-0 translate-y-2"
      :class="feedback.ok ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-red-50 border-red-200 text-red-700'"
      class="fixed bottom-6 right-6 z-50 border rounded-xl px-4 py-3 text-sm font-medium shadow-lg"
      x-text="feedback.msg"
    ></div>

    <!-- Skeleton -->
    <div x-show="loading" class="space-y-4 animate-pulse">
      <div class="h-7 bg-slate-200 rounded-xl w-40"></div>
      <div class="h-28 bg-slate-100 rounded-2xl"></div>
      <div class="h-24 bg-slate-100 rounded-2xl"></div>
    </div>

    <!-- Erro -->
    <div
      x-show="!loading && error"
      class="flex flex-col items-center py-16 text-slate-400"
    >
      <p class="text-base font-medium" x-text="error"></p>
    </div>

    <!-- Conteúdo -->
    <template x-if="!loading && order">
      <div class="space-y-4">
        <!-- Cabeçalho -->
        <div class="flex flex-wrap items-center gap-3">
          <h1 class="text-xl font-bold text-slate-800">
            Pedido <span class="font-mono" x-text="'#' + order.id"></span>
          </h1>
          <span
            :class="statusBadgeClass()"
            class="text-xs font-bold px-2.5 py-1 rounded-full"
            x-text="statusLabel()"
          ></span>
        </div>

        <!-- Info compacta -->
        <div
          class="bg-white/90 border border-slate-200 rounded-2xl shadow-sm p-5"
        >
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-4">
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Cliente
              </p>
              <p
                class="text-sm font-semibold text-slate-800 mt-0.5"
                x-text="order.client_name || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Produto
              </p>
              <p
                class="text-sm font-semibold text-slate-800 mt-0.5"
                x-text="order.product_type_name || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Versão
              </p>
              <p
                class="text-sm font-mono font-semibold text-slate-700 mt-0.5"
                x-text="order.version || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Tipo de Leitor
              </p>
              <p
                class="text-sm text-slate-700 mt-0.5"
                x-text="order.reader_type_name || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Serial
              </p>
              <p
                class="text-sm font-mono text-slate-600 mt-0.5"
                x-text="order.reader_serial || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Hostname
              </p>
              <p
                class="text-sm font-mono text-slate-600 mt-0.5"
                x-text="order.reader_hostname || '\u2014'"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Criado em
              </p>
              <p
                class="text-sm font-mono text-slate-500 mt-0.5"
                x-text="formatDateTime(order.created_at)"
              ></p>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
              >
                Atualizado em
              </p>
              <p
                class="text-sm font-mono text-slate-500 mt-0.5"
                x-text="formatDateTime(order.updated_at)"
              ></p>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <div
          class="bg-white/90 border border-slate-200 rounded-2xl shadow-sm p-5"
        >
          <p
            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4"
          >
            Progresso
          </p>
          <div class="flex items-start">
            <template x-for="(step, idx) in timeline" :key="step.key">
              <div class="flex-1 flex flex-col items-center relative">
                <div
                  x-show="idx > 0"
                  :class="step.done ? 'bg-blue-400' : 'bg-slate-200'"
                  class="absolute top-4 right-1/2 left-0 h-0.5"
                ></div>
                <div
                  :class="step.done ? 'bg-blue-500 border-blue-500 text-white' : step.current ? 'bg-white border-blue-400 text-blue-400 ring-2 ring-blue-100' : 'bg-white border-slate-200 text-slate-300'"
                  class="relative z-10 w-8 h-8 rounded-full border-2 flex items-center justify-center shrink-0"
                >
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      :d="step.icon"
                    />
                  </svg>
                </div>
                <p
                  :class="step.done ? 'text-slate-700 font-semibold' : step.current ? 'text-blue-500 font-semibold' : 'text-slate-400'"
                  class="text-xs mt-2 text-center"
                  x-text="step.label"
                ></p>
                <p
                  :class="step.done ? 'text-slate-500' : 'text-slate-300'"
                  class="text-[10px] mt-0.5 text-center font-mono"
                  x-text="step.date ? formatDate(step.date) : '\u2014'"
                ></p>
              </div>
            </template>
          </div>
        </div>

        <!-- Modal de confirmação -->
        <div
          x-show="pendingAction"
          x-transition:enter="transition ease-out duration-150"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
          class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
          @click.self="pendingAction = null"
          @keydown.escape.window="pendingAction = null"
        >
          <div
            x-show="pendingAction"
            x-transition:enter="transition ease-out duration-150"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-4"
          >
            <h3 class="text-base font-bold text-slate-800 mb-1">
              Confirmar ação
            </h3>
            <p class="text-sm text-slate-500 mb-6">
              Deseja realmente
              <strong class="text-slate-700" x-text="pendingLabel"></strong>?
            </p>
            <div class="flex justify-end gap-2">
              <button
                @click="pendingAction = null"
                :disabled="acting"
                class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-xl transition-all"
              >
                Cancelar
              </button>
              <button
                @click="doAction()"
                :disabled="acting"
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
              >
                <svg
                  x-show="acting"
                  class="w-3.5 h-3.5 animate-spin"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                Confirmar
              </button>
            </div>
          </div>
        </div>

        <!-- Modal vincular leitor -->
        <div
          x-show="showReaderPicker"
          x-transition:enter="transition ease-out duration-150"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
          class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
          @click.self="showReaderPicker = false; selectedReaderId = ''"
          @keydown.escape.window="showReaderPicker = false; selectedReaderId = ''"
        >
          <div
            x-show="showReaderPicker"
            x-transition:enter="transition ease-out duration-150"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-4"
          >
            <h3 class="text-base font-bold text-slate-800 mb-1">
              Vincular Leitor
            </h3>
            <p class="text-sm text-slate-500 mb-4">
              Selecione um leitor disponível para vincular a este pedido.
            </p>

            <!-- Carregando -->
            <div
              x-show="loadingReaders"
              class="flex items-center gap-2 text-sm text-slate-400 py-2"
            >
              <svg
                class="w-4 h-4 animate-spin"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Carregando leitores...
            </div>

            <!-- Sem leitores -->
            <p
              x-show="!loadingReaders && readers.length === 0"
              class="text-sm text-amber-600 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2.5 mb-4"
            >
              Nenhum leitor disponível no momento.
            </p>

            <!-- Select -->
            <select
              x-show="!loadingReaders && readers.length > 0"
              x-model="selectedReaderId"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-5"
            >
              <option value="">Selecione um leitor...</option>
              <template x-for="r in readers" :key="r.id">
                <option :value="r.id" x-text="readerLabel(r)"></option>
              </template>
            </select>

            <div class="flex justify-end gap-2">
              <button
                @click="showReaderPicker = false; selectedReaderId = ''"
                class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-xl transition-all"
              >
                Cancelar
              </button>
              <button
                @click="addReader()"
                :disabled="!selectedReaderId || acting"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
              >
                Vincular
              </button>
            </div>
          </div>
        </div>

        <!-- Ações -->
        <div
          class="bg-white/90 border border-slate-200 rounded-2xl shadow-sm p-5"
        >
          <p
            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3"
          >
            Ações
          </p>
          <div class="flex flex-wrap gap-2">
            <button
              x-show="!order.mounted_at"
              @click="pendingAction = 'mount'; pendingLabel = 'Marcar como Montado'"
              :disabled="acting"
              class="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
            >
              Marcar Montado
            </button>
            <button
              x-show="order.mounted_at && !order.tested_at"
              @click="pendingAction = 'test'; pendingLabel = 'Marcar como Testado'"
              :disabled="acting"
              class="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
            >
              Marcar Testado
            </button>
            <button
              x-show="order.tested_at && !order.shipped_at"
              @click="pendingAction = 'ship'; pendingLabel = 'Marcar como Enviado'"
              :disabled="acting"
              class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
            >
              Marcar Enviado
            </button>
            <button
              x-show="order.shipped_at && !order.activated_at"
              @click="pendingAction = 'activate'; pendingLabel = 'Marcar como Ativado'"
              :disabled="acting"
              class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
            >
              Marcar Ativado
            </button>

            <!-- Vincular Leitor -->
            <button
              x-show="!order.reader_id"
              @click="openReaderPicker()"
              :disabled="acting"
              class="px-3 py-2 bg-slate-600 hover:bg-slate-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl transition-all"
            >
              Vincular Leitor
            </button>
            <div
              x-show="order.activated_at"
              class="flex items-center gap-1.5 text-emerald-600 text-sm font-semibold"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Pedido concluído
            </div>
            <div
              x-show="acting"
              class="flex items-center gap-1.5 text-sm text-slate-400"
            >
              <svg
                class="w-4 h-4 animate-spin"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Processando...
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</div>

<script>
  function viewOrder() {
    return {
      order: null,
      loading: true,
      acting: false,
      error: "",
      feedback: { msg: "", ok: true },
      pendingAction: null,
      pendingLabel: "",
      _feedbackTimer: null,
      showReaderPicker: false,
      readers: [],
      loadingReaders: false,
      selectedReaderId: "",

      async init() {
        await this.load();
      },

      async load() {
        this.loading = true;
        this.error = "";
        try {
          const res = await fetch(VIEW_ORDER_URLS.getDecodedOrder);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          this.order = await res.json();
        } catch (e) {
          this.error = `Erro ao carregar pedido: ${e.message}`;
        } finally {
          this.loading = false;
        }
      },

      async doAction() {
        if (!this.pendingAction) return;
        const action = this.pendingAction;
        this.pendingAction = null;
        this.acting = true;
        this.feedback = { msg: "", ok: true };
        try {
          const res = await fetch(VIEW_ORDER_URLS[action], { method: "PUT" });
          const data = await res.json();
          if (!res.ok) {
            this.showFeedback(data.error ?? "Erro ao executar a ação.", false);
          } else {
            this.showFeedback(data.message ?? "Sucesso!", true);
            await this.load();
          }
        } catch (e) {
          this.showFeedback(`Erro inesperado: ${e.message}`, false);
        } finally {
          this.acting = false;
        }
      },

      showFeedback(msg, ok) {
        this.feedback = { msg, ok };
        clearTimeout(this._feedbackTimer);
        this._feedbackTimer = setTimeout(() => {
          this.feedback = { msg: "", ok: true };
        }, 4000);
      },

      async openReaderPicker() {
        this.showReaderPicker = true;
        this.selectedReaderId = "";
        this.loadingReaders = true;
        try {
          const res = await fetch(VIEW_ORDER_URLS.getAvailableReaders);
          if (!res.ok) throw new Error();
          const ids = await res.json();
          if (!Array.isArray(ids) || ids.length === 0) {
            this.readers = [];
            return;
          }
          const idList = ids
            .map((item) =>
              typeof item === "object" && item !== null ? item.id : item,
            )
            .join(",");
          const res2 = await fetch(
            VIEW_ORDER_URLS.getDecodedReadersByIds.replace("__IDS__", idList),
          );
          if (res2.ok) this.readers = await res2.json();
        } catch (_) {
          this.readers = [];
        } finally {
          this.loadingReaders = false;
        }
      },

      async addReader() {
        if (!this.selectedReaderId) return;
        this.acting = true;
        this.showReaderPicker = false;
        try {
          const url = VIEW_ORDER_URLS.addReaderToOrder.replace(
            "__RID__",
            this.selectedReaderId,
          );
          const res = await fetch(url, { method: "POST" });
          const data = await res.json();
          if (!res.ok) {
            this.showFeedback(data.error ?? "Erro ao vincular leitor.", false);
          } else {
            this.showFeedback(data.message ?? "Leitor vinculado!", true);
            await this.load();
          }
        } catch (e) {
          this.showFeedback(`Erro inesperado: ${e.message}`, false);
        } finally {
          this.acting = false;
          this.selectedReaderId = "";
        }
      },

      readerLabel(r) {
        const parts = [];
        if (r.hostname) parts.push(r.hostname);
        if (r.serial_number) parts.push(r.serial_number);
        if (r.reader_type_name) parts.push(`(${r.reader_type_name})`);
        return parts.length ? parts.join(" — ") : `Leitor #${r.id}`;
      },

      statusLabel() {
        if (!this.order) return "";
        if (this.order.activated_at) return "Ativado";
        if (this.order.shipped_at) return "Enviado";
        if (this.order.tested_at) return "Testado";
        if (this.order.mounted_at) return "Montado";
        return "Pendente";
      },

      statusBadgeClass() {
        if (!this.order) return "";
        if (this.order.activated_at)
          return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
        if (this.order.shipped_at)
          return "bg-indigo-100 text-indigo-700 ring-1 ring-indigo-200";
        if (this.order.tested_at)
          return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
        if (this.order.mounted_at)
          return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      },

      get timeline() {
        if (!this.order) return [];
        const o = this.order;
        return [
          {
            key: "pendente",
            label: "Criado",
            date: o.created_at,
            done: true,
            current: false,
            icon: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2",
          },
          {
            key: "montado",
            label: "Montado",
            date: o.mounted_at,
            done: !!o.mounted_at,
            current: !o.mounted_at,
            icon: "M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z",
          },
          {
            key: "testado",
            label: "Testado",
            date: o.tested_at,
            done: !!o.tested_at,
            current: !!o.mounted_at && !o.tested_at,
            icon: "M9 12l2 2 4-4M7 4a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2H7z",
          },
          {
            key: "enviado",
            label: "Enviado",
            date: o.shipped_at,
            done: !!o.shipped_at,
            current: !!o.tested_at && !o.shipped_at,
            icon: "M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4",
          },
          {
            key: "ativado",
            label: "Ativado",
            date: o.activated_at,
            done: !!o.activated_at,
            current: !!o.shipped_at && !o.activated_at,
            icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
          },
        ];
      },

      formatDate(value) {
        if (!value) return "\u2014";
        try {
          return new Intl.DateTimeFormat("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          }).format(new Date(value));
        } catch (_) {
          return value;
        }
      },

      formatDateTime(value) {
        if (!value) return "\u2014";
        try {
          return new Intl.DateTimeFormat("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          }).format(new Date(value));
        } catch (_) {
          return value;
        }
      },
    };
  }
</script>
{% endblock %}
