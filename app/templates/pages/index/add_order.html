{% extends "base.html" %} {% block content %}
<!-- Main Layout Container -->
<!-- Criar Pedido -->
<script>
  const ADD_ORDER_URLS = {
    getCustomers: "{{ url_for('get_customers') }}",
    getProductTypes: "{{ url_for('get_product_types') }}",
    getAvailableReaders: "{{ url_for('get_available_readers') }}",
    getDecodedReadersByIds:
      "{{ url_for('get_decoded_readers_by_ids', reader_ids='__IDS__') }}",
    addProductOrder: "{{ url_for('add_product_order') }}",
    backUrl: "{{ url_for('index') }}",
  };
</script>

<div class="min-h-screen p-6" x-data="addOrderForm()" x-init="init()">
  <!-- Card do formulário -->
  <div
    class="max-w-2xl mx-auto bg-white/90 border border-slate-200 rounded-2xl shadow-sm p-8"
  >
    <!-- Sucesso -->
    <div
      x-show="success"
      x-transition
      class="mb-6 flex items-start gap-3 bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-xl p-4 text-sm"
    >
      <svg
        class="w-5 h-5 shrink-0 mt-0.5 text-emerald-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <div>
        <p class="font-semibold">Pedido criado com sucesso!</p>
        <p class="mt-0.5 text-emerald-600" x-text="successMsg"></p>
      </div>
    </div>

    <!-- Erro -->
    <div
      x-show="error"
      x-transition
      class="mb-6 flex items-start gap-3 bg-red-50 border border-red-200 text-red-800 rounded-xl p-4 text-sm"
    >
      <svg
        class="w-5 h-5 shrink-0 mt-0.5 text-red-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <p x-text="error"></p>
    </div>

    <form @submit.prevent="submit()" class="space-y-6" x-show="!success">
      <!-- Produto -->
      <div>
        <label
          class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5"
        >
          Tipo de Produto <span class="text-red-400">*</span>
        </label>
        {{ combobox("ptSearch", "form.product_type_id", "() => productTypes",
        "pt => pt.id + ' \u2014 ' + pt.name", "id", "Selecione um produto") }}
      </div>

      <!-- Cliente -->
      <div>
        <label
          class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5"
        >
          Cliente <span class="text-red-400">*</span>
        </label>
        {{ combobox("cSearch", "form.client_id", "() => customers", "c => c.ID +
        ' \u2014 ' + (c.NAME ?? 'Desconhecido')", "ID", "Selecione um cliente")
        }}
      </div>

      <!-- Leitor -->
      <div>
        <label
          class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5"
        >
          Leitor Disponível
          <span class="text-slate-400 font-normal normal-case tracking-normal"
            >(opcional)</span
          >
        </label>

        <!-- Estado: carregando leitores -->
        <div
          x-show="loadingReaders"
          class="flex items-center gap-2 text-sm text-slate-400 py-2"
        >
          <svg
            class="w-4 h-4 animate-spin"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          Carregando leitores...
        </div>

        <!-- Sem leitores disponíveis -->
        <div
          x-show="!loadingReaders && readers.length === 0"
          class="text-sm text-amber-600 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2.5"
        >
          Nenhum leitor disponível no momento.
        </div>

        <!-- Select de leitores -->
        <div x-show="!loadingReaders && readers.length > 0">
          {{ combobox("rSearch", "form.reader_id", "() => readers", "r =>
          readerLabel(r)", "id", "Selecione um leitor") }}

          <!-- Detalhe do leitor selecionado -->
          <template x-if="selectedReader">
            <div class="mt-2 grid grid-cols-3 gap-2">
              <template
                x-for="[key, val] in readerDetails(selectedReader)"
                :key="key"
              >
                <div
                  class="bg-slate-50 border border-slate-100 rounded-lg px-3 py-2"
                >
                  <p
                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wide"
                    x-text="key"
                  ></p>
                  <p
                    class="text-sm text-slate-700 font-medium mt-0.5"
                    x-text="val || '—'"
                  ></p>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Versão -->
      <div>
        <label
          class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5"
        >
          Versão <span class="text-red-400">*</span>
        </label>
        <input
          type="text"
          x-model="form.version"
          placeholder="ex: v1.0.0"
          class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2.5 text-sm text-slate-800 font-mono focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
        />
      </div>

      <!-- Botões -->
      <div class="flex items-center gap-3 pt-2">
        <button
          type="submit"
          :disabled="submitting || !isValid"
          class="inline-flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 disabled:opacity-40 text-white text-sm font-semibold rounded-xl shadow-sm transition-all"
        >
          <svg
            x-show="submitting"
            class="w-4 h-4 animate-spin"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          <span x-text="submitting ? 'Criando...' : 'Criar Pedido'"></span>
        </button>
        <a
          href="{{ url_for('index') }}"
          class="px-5 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-xl transition-all"
        >
          Cancelar
        </a>
      </div>
    </form>

    <!-- Após sucesso: opções -->
    <div x-show="success" x-transition class="flex gap-3 mt-6">
      <a
        href="{{ url_for('index') }}"
        class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-xl transition-all"
      >
        Ver Pedidos
      </a>
      <button
        @click="reset()"
        class="px-5 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-xl transition-all"
      >
        Criar Outro
      </button>
    </div>
  </div>
</div>

<script>
  function addOrderForm() {
    return {
      form: { product_type_id: "", client_id: "", reader_id: "", version: "" },
      customers: [],
      productTypes: [],
      readers: [],
      loadingReaders: true,
      submitting: false,
      success: false,
      successMsg: "",
      error: "",

      async init() {
        await Promise.all([
          this.loadCustomers(),
          this.loadProductTypes(),
          this.loadReaders(),
        ]);
      },

      async loadCustomers() {
        try {
          const res = await fetch(ADD_ORDER_URLS.getCustomers);
          if (res.ok) this.customers = await res.json();
        } catch (_) {}
      },

      async loadProductTypes() {
        try {
          const res = await fetch(ADD_ORDER_URLS.getProductTypes);
          if (res.ok) this.productTypes = await res.json();
        } catch (_) {}
      },

      async loadReaders() {
        this.loadingReaders = true;
        try {
          const res = await fetch(ADD_ORDER_URLS.getAvailableReaders);
          if (!res.ok) throw new Error();
          const ids = await res.json();
          if (!Array.isArray(ids) || ids.length === 0) {
            this.readers = [];
            return;
          }
          const idList = ids
            .map((item) =>
              typeof item === "object" && item !== null ? item.id : item,
            )
            .join(",");
          const res2 = await fetch(
            ADD_ORDER_URLS.getDecodedReadersByIds.replace("__IDS__", idList),
          );
          if (res2.ok) this.readers = await res2.json();
        } catch (_) {
          this.readers = [];
        } finally {
          this.loadingReaders = false;
        }
      },

      get selectedReader() {
        if (!this.form.reader_id) return null;
        return this.readers.find((r) => r.id == this.form.reader_id) ?? null;
      },

      readerLabel(r) {
        const parts = [];
        if (r.hostname) parts.push(r.hostname);
        if (r.serial_number) parts.push(r.serial_number);
        if (r.reader_type_name) parts.push(`(${r.reader_type_name})`);
        return parts.length ? parts.join(" — ") : `Leitor #${r.id}`;
      },

      readerDetails(r) {
        return Object.entries(r).filter(
          ([k]) => !k.endsWith("_id") && k !== "id",
        );
      },

      get isValid() {
        return (
          this.form.product_type_id &&
          this.form.client_id &&
          this.form.version.trim()
        );
      },

      async submit() {
        this.error = "";
        this.submitting = true;
        try {
          const res = await fetch(ADD_ORDER_URLS.addProductOrder, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              product_type_id: parseInt(this.form.product_type_id),
              client_id: parseInt(this.form.client_id),
              reader_id: this.form.reader_id
                ? parseInt(this.form.reader_id)
                : null,
              version: this.form.version.trim(),
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            this.error = data.error ?? "Erro ao criar pedido.";
          } else {
            this.success = true;
            this.successMsg = data.message ?? "";
          }
        } catch (e) {
          this.error = `Erro inesperado: ${e.message}`;
        } finally {
          this.submitting = false;
        }
      },

      reset() {
        this.form = {
          product_type_id: "",
          client_id: "",
          reader_id: "",
          version: "",
        };
        this.success = false;
        this.successMsg = "";
        this.error = "";
      },
    };
  }
</script>
{% endblock %}
